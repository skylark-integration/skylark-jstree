/**
 * skylark-jstree - A version of jstree that ported to running on skylarkjs ui.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylarkui/skylark-jstree/
 * @license MIT
 */
define(["skylark-langx/langx","skylark-utils-dom/browser","skylark-utils-dom/eventer","skylark-utils-dom/noder","skylark-utils-dom/geom","skylark-utils-dom/query","../tree"],function(t,e,i,r,a,s,d){"use strict";if(!s.jstree.plugins.types)return s.jstree.defaults.types={"default":{}},s.jstree.defaults.types[s.jstree.root]={},s.jstree.plugins.types=function(t,e){this.init=function(t,i){var r,a;if(i&&i.types&&i.types["default"])for(r in i.types)if("default"!==r&&r!==s.jstree.root&&i.types.hasOwnProperty(r))for(a in i.types["default"])i.types["default"].hasOwnProperty(a)&&void 0===i.types[r][a]&&(i.types[r][a]=i.types["default"][a]);e.init.call(this,t,i),this._model.data[s.jstree.root].type=s.jstree.root},this.refresh=function(t,i){e.refresh.call(this,t,i),this._model.data[s.jstree.root].type=s.jstree.root},this.bind=function(){this.element.on("model.jstree",s.proxy(function(t,e){var i,r,a,d=this._model.data,l=e.nodes,n=this.settings.types,o="default";for(i=0,r=l.length;i<r;i++){if(o="default",d[l[i]].original&&d[l[i]].original.type&&n[d[l[i]].original.type]&&(o=d[l[i]].original.type),d[l[i]].data&&d[l[i]].data.jstree&&d[l[i]].data.jstree.type&&n[d[l[i]].data.jstree.type]&&(o=d[l[i]].data.jstree.type),d[l[i]].type=o,d[l[i]].icon===!0&&void 0!==n[o].icon&&(d[l[i]].icon=n[o].icon),void 0!==n[o].li_attr&&"object"==typeof n[o].li_attr)for(a in n[o].li_attr)if(n[o].li_attr.hasOwnProperty(a)){if("id"===a)continue;void 0===d[l[i]].li_attr[a]?d[l[i]].li_attr[a]=n[o].li_attr[a]:"class"===a&&(d[l[i]].li_attr["class"]=n[o].li_attr["class"]+" "+d[l[i]].li_attr["class"])}if(void 0!==n[o].a_attr&&"object"==typeof n[o].a_attr)for(a in n[o].a_attr)if(n[o].a_attr.hasOwnProperty(a)){if("id"===a)continue;void 0===d[l[i]].a_attr[a]?d[l[i]].a_attr[a]=n[o].a_attr[a]:"href"===a&&"#"===d[l[i]].a_attr[a]?d[l[i]].a_attr.href=n[o].a_attr.href:"class"===a&&(d[l[i]].a_attr["class"]=n[o].a_attr["class"]+" "+d[l[i]].a_attr["class"])}}d[s.jstree.root].type=s.jstree.root},this)),e.bind.call(this)},this.get_json=function(t,i,r){var a,d,l=this._model.data,n=i?s.extend(!0,{},i,{no_id:!1}):{},o=e.get_json.call(this,t,n,r);if(o===!1)return!1;if(s.isArray(o))for(a=0,d=o.length;a<d;a++)o[a].type=o[a].id&&l[o[a].id]&&l[o[a].id].type?l[o[a].id].type:"default",i&&i.no_id&&(delete o[a].id,o[a].li_attr&&o[a].li_attr.id&&delete o[a].li_attr.id,o[a].a_attr&&o[a].a_attr.id&&delete o[a].a_attr.id);else o.type=o.id&&l[o.id]&&l[o.id].type?l[o.id].type:"default",i&&i.no_id&&(o=this._delete_ids(o));return o},this._delete_ids=function(t){if(s.isArray(t)){for(var e=0,i=t.length;e<i;e++)t[e]=this._delete_ids(t[e]);return t}return delete t.id,t.li_attr&&t.li_attr.id&&delete t.li_attr.id,t.a_attr&&t.a_attr.id&&delete t.a_attr.id,t.children&&s.isArray(t.children)&&(t.children=this._delete_ids(t.children)),t},this.check=function(t,i,r,a,d){if(e.check.call(this,t,i,r,a,d)===!1)return!1;i=i&&i.id?i:this.get_node(i),r=r&&r.id?r:this.get_node(r);var l,n,o,_,c=i&&i.id?d&&d.origin?d.origin:s.jstree.reference(i.id):null;switch(c=c&&c._model&&c._model.data?c._model.data:null,t){case"create_node":case"move_node":case"copy_node":if("move_node"!==t||s.inArray(i.id,r.children)===-1){if(l=this.get_rules(r),void 0!==l.max_children&&l.max_children!==-1&&l.max_children===r.children.length)return this._data.core.last_error={error:"check",plugin:"types",id:"types_01",reason:"max_children prevents function: "+t,data:JSON.stringify({chk:t,pos:a,obj:!(!i||!i.id)&&i.id,par:!(!r||!r.id)&&r.id})},!1;if(void 0!==l.valid_children&&l.valid_children!==-1&&s.inArray(i.type||"default",l.valid_children)===-1)return this._data.core.last_error={error:"check",plugin:"types",id:"types_02",reason:"valid_children prevents function: "+t,data:JSON.stringify({chk:t,pos:a,obj:!(!i||!i.id)&&i.id,par:!(!r||!r.id)&&r.id})},!1;if(c&&i.children_d&&i.parents){for(n=0,o=0,_=i.children_d.length;o<_;o++)n=Math.max(n,c[i.children_d[o]].parents.length);n=n-i.parents.length+1}(n<=0||void 0===n)&&(n=1);do{if(void 0!==l.max_depth&&l.max_depth!==-1&&l.max_depth<n)return this._data.core.last_error={error:"check",plugin:"types",id:"types_03",reason:"max_depth prevents function: "+t,data:JSON.stringify({chk:t,pos:a,obj:!(!i||!i.id)&&i.id,par:!(!r||!r.id)&&r.id})},!1;r=this.get_node(r.parent),l=this.get_rules(r),n++}while(r)}}return!0},this.get_rules=function(t){if(t=this.get_node(t),!t)return!1;var e=this.get_type(t,!0);return void 0===e.max_depth&&(e.max_depth=-1),void 0===e.max_children&&(e.max_children=-1),void 0===e.valid_children&&(e.valid_children=-1),e},this.get_type=function(t,e){return t=this.get_node(t),!!t&&(e?s.extend({type:t.type},this.settings.types[t.type]):t.type)},this.set_type=function(t,e){var i,r,a,d,l,n,o,_,c=this._model.data;if(s.isArray(t)){for(t=t.slice(),r=0,a=t.length;r<a;r++)this.set_type(t[r],e);return!0}if(i=this.settings.types,t=this.get_node(t),!i[e]||!t)return!1;if(o=this.get_node(t,!0),o&&o.length&&(_=o.children(".jstree-anchor")),d=t.type,l=this.get_icon(t),t.type=e,(l===!0||!i[d]||void 0!==i[d].icon&&l===i[d].icon)&&this.set_icon(t,void 0===i[e].icon||i[e].icon),i[d]&&void 0!==i[d].li_attr&&"object"==typeof i[d].li_attr)for(n in i[d].li_attr)if(i[d].li_attr.hasOwnProperty(n)){if("id"===n)continue;"class"===n?(c[t.id].li_attr["class"]=(c[t.id].li_attr["class"]||"").replace(i[d].li_attr[n],""),o&&o.removeClass(i[d].li_attr[n])):c[t.id].li_attr[n]===i[d].li_attr[n]&&(c[t.id].li_attr[n]=null,o&&o.removeAttr(n))}if(i[d]&&void 0!==i[d].a_attr&&"object"==typeof i[d].a_attr)for(n in i[d].a_attr)if(i[d].a_attr.hasOwnProperty(n)){if("id"===n)continue;"class"===n?(c[t.id].a_attr["class"]=(c[t.id].a_attr["class"]||"").replace(i[d].a_attr[n],""),_&&_.removeClass(i[d].a_attr[n])):c[t.id].a_attr[n]===i[d].a_attr[n]&&("href"===n?(c[t.id].a_attr[n]="#",_&&_.attr("href","#")):(delete c[t.id].a_attr[n],_&&_.removeAttr(n)))}if(void 0!==i[e].li_attr&&"object"==typeof i[e].li_attr)for(n in i[e].li_attr)if(i[e].li_attr.hasOwnProperty(n)){if("id"===n)continue;void 0===c[t.id].li_attr[n]?(c[t.id].li_attr[n]=i[e].li_attr[n],o&&("class"===n?o.addClass(i[e].li_attr[n]):o.attr(n,i[e].li_attr[n]))):"class"===n&&(c[t.id].li_attr["class"]=i[e].li_attr[n]+" "+c[t.id].li_attr["class"],o&&o.addClass(i[e].li_attr[n]))}if(void 0!==i[e].a_attr&&"object"==typeof i[e].a_attr)for(n in i[e].a_attr)if(i[e].a_attr.hasOwnProperty(n)){if("id"===n)continue;void 0===c[t.id].a_attr[n]?(c[t.id].a_attr[n]=i[e].a_attr[n],_&&("class"===n?_.addClass(i[e].a_attr[n]):_.attr(n,i[e].a_attr[n]))):"href"===n&&"#"===c[t.id].a_attr[n]?(c[t.id].a_attr.href=i[e].a_attr.href,_&&_.attr("href",i[e].a_attr.href)):"class"===n&&(c[t.id].a_attr["class"]=i[e].a_attr["class"]+" "+c[t.id].a_attr["class"],_&&_.addClass(i[e].a_attr[n]))}return!0}},s});
//# sourceMappingURL=../sourcemaps/plugin/types.js.map
